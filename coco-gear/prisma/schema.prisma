generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Users / Personnel ───
model User {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  title     String?
  role      String   @default("user") // developer | director | engineer | manager | lead | user
  pin       String   // bcrypt hashed
  mustChangePassword Boolean @default(true)
  deptId    String?
  dashboardConfig Json?    // { widgets: [{ id, visible, order }], columns?: number }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department      Department?        @relation("UserDepartment", fields: [deptId], references: [id], onDelete: SetNull)
  managedDepts    DepartmentManager[] @relation("DeptManager")
  ledDepts        DepartmentLead[]    @relation("DeptLead")
  kitCheckouts    IssueHistory[]     @relation("IssuedTo")
  kitIssuedBy     IssueHistory[]     @relation("IssuedBy")
  assetCheckouts  AssetIssueHistory[] @relation("AssetIssuedTo")
  assetIssuedBy   AssetIssueHistory[] @relation("AssetIssuedBy")
  checkoutRequests CheckoutRequest[] @relation("Requester")
  resolvedRequests CheckoutRequest[] @relation("Resolver")
  reservations    Reservation[]
  maintenanceStarted MaintenanceHistory[] @relation("MaintStartedBy")
  maintenanceCompleted MaintenanceHistory[] @relation("MaintCompletedBy")
  auditLogs       AuditLog[]
  kitsIssued      Kit[]              @relation("KitHolder")
  tripAssignments TripPersonnel[]    @relation("TripAssignment")
  tripsLed        Trip[]             @relation("TripLead")
  tripNotes       TripNote[]         @relation("TripNoteAuthor")
  tasksAssigned   TripTask[]         @relation("TaskAssignee")
  tasksCompleted  TripTask[]         @relation("TaskCompleter")
  packingChecks   TripPackingCheck[] @relation("PackingChecks")
  commsAssignments TripCommsEntry[]  @relation("CommsAssignment")

  @@index([role])
  @@index([deptId])
}

// ─── Departments ───
model Department {
  id        String   @id @default(uuid())
  name      String
  color     String   @default("#60a5fa")
  site      String?  // physical site/location e.g. "CA - San Diego", "VA - Norfolk"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  managers  DepartmentManager[]
  leads     DepartmentLead[]
  members   User[]   @relation("UserDepartment")
  kits      Kit[]
  checkoutRequests CheckoutRequest[]
  kitTypes  KitTypeDepartment[]
}

// ─── Department <-> Manager (many-to-many) ───
model DepartmentManager {
  id     String @id @default(uuid())
  deptId String
  userId String

  department Department @relation(fields: [deptId], references: [id], onDelete: Cascade)
  user       User       @relation("DeptManager", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([deptId, userId])
  @@index([deptId])
  @@index([userId])
}

// ─── Department <-> Lead (many-to-many) ───
model DepartmentLead {
  id     String @id @default(uuid())
  deptId String
  userId String

  department Department @relation(fields: [deptId], references: [id], onDelete: Cascade)
  user       User       @relation("DeptLead", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([deptId, userId])
  @@index([deptId])
  @@index([userId])
}

// ─── Locations ───
model Location {
  id        String   @id @default(uuid())
  name      String
  shortCode String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kits      Kit[]
  assets    StandaloneAsset[]
}

// ─── Components (the library of possible kit parts) ───
model Component {
  id                    String   @id @default(uuid())
  key                   String   @unique
  label                 String
  category              String   // Comms, Power, Cables, Cases, Optics, Other
  serialized            Boolean  @default(false)
  qrScannable           Boolean  @default(true)
  calibrationRequired   Boolean  @default(false)
  calibrationIntervalDays Int?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  kitTypeComponents     KitTypeComponent[]
  kitComponentStatuses  KitComponentStatus[]
  kitSerials            KitSerial[]
  kitCalibrationDates   KitCalibrationDate[]
  inspectionResults     InspectionResult[]

  @@index([category])
}

// ─── Kit Types (templates) ───
model KitType {
  id        String   @id @default(uuid())
  name      String
  desc      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  components  KitTypeComponent[]
  fields      KitTypeField[]
  kits        Kit[]
  departments KitTypeDepartment[]
}

// ─── Kit Type <-> Department (many-to-many) ───
model KitTypeDepartment {
  id        String @id @default(uuid())
  kitTypeId String
  deptId    String

  kitType    KitType    @relation(fields: [kitTypeId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [deptId], references: [id], onDelete: Cascade)

  @@unique([kitTypeId, deptId])
}

// ─── Kit Type <-> Component (many-to-many with qty) ───
model KitTypeComponent {
  id          String  @id @default(uuid())
  kitTypeId   String
  componentId String
  quantity    Int     @default(1)
  critical    Boolean @default(false) // If true, kit is degraded when this component is DAMAGED or MISSING

  kitType   KitType   @relation(fields: [kitTypeId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([kitTypeId, componentId])
}

// ─── Kit Type custom fields ───
model KitTypeField {
  id        String @id @default(uuid())
  kitTypeId String
  key       String
  label     String
  type      String @default("text") // text | number | toggle

  kitType   KitType @relation(fields: [kitTypeId], references: [id], onDelete: Cascade)

  @@unique([kitTypeId, key])
}

// ─── Kits (actual instances) ───
model Kit {
  id                String   @id @default(uuid())
  typeId            String
  color             String
  locId             String
  deptId            String?
  issuedToId        String?
  tripId            String?
  lastChecked       DateTime?
  maintenanceStatus String?  // null | repair | calibration | upgrade | cleaning
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  type              KitType           @relation(fields: [typeId], references: [id])
  location          Location          @relation(fields: [locId], references: [id])
  department        Department?       @relation(fields: [deptId], references: [id], onDelete: SetNull)
  issuedTo          User?             @relation("KitHolder", fields: [issuedToId], references: [id], onDelete: SetNull)
  trip              Trip?             @relation(fields: [tripId], references: [id], onDelete: SetNull)
  fieldValues       KitFieldValue[]
  componentStatuses KitComponentStatus[]
  serials           KitSerial[]
  calibrationDates  KitCalibrationDate[]
  inspections       Inspection[]
  issueHistory      IssueHistory[]
  maintenanceHistory MaintenanceHistory[]
  checkoutRequests  CheckoutRequest[]
  reservations      Reservation[]
  photos            KitPhoto[]

  @@index([typeId])
  @@index([locId])
  @@index([deptId])
  @@index([issuedToId])
  @@index([tripId])
  @@index([color])
}

// ─── Trips / Missions ───
model Trip {
  id          String   @id @default(uuid())
  name        String
  description String?
  location    String?
  objectives  String?
  leadId      String?
  startDate   DateTime
  endDate     DateTime
  status      String   @default("planning") // planning | active | completed | cancelled
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lead          User?            @relation("TripLead", fields: [leadId], references: [id], onDelete: SetNull)
  kits          Kit[]
  boats         TripBoat[]
  reservations  Reservation[]
  personnel     TripPersonnel[]
  notes         TripNote[]
  tasks         TripTask[]
  packingItems  TripPackingItem[]
  packingChecks TripPackingCheck[]
  commsEntries  TripCommsEntry[]

  @@index([status])
  @@index([startDate, endDate])
  @@index([leadId])
}

// ─── Trip Personnel (who is assigned to a trip) ───
model TripPersonnel {
  id        String   @id @default(uuid())
  tripId    String
  userId    String
  role      String   @default("specialist") // director | manager | senior-spec | specialist | engineer | other
  notes     String?
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation("TripAssignment", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

// ─── Trip Notes / Log ───
model TripNote {
  id        String   @id @default(uuid())
  tripId    String
  authorId  String
  content   String
  category  String   @default("general") // general | logistics | safety | comms | after-action
  createdAt DateTime @default(now())

  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  author User @relation("TripNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

// ─── USVs (Unmanned Surface Vehicles) ───
model Boat {
  id           String   @id @default(uuid())
  name         String
  type         String?  // e.g. WAM-V, Heron, Sailbuoy, custom
  hullId       String?  // hull or serial number
  length       Float?   // length in meters
  homePort     String?
  status       String   @default("available") // available | maintenance | decommissioned
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  trips TripBoat[]

  @@index([status])
}

// ─── Trip <-> Boat (many-to-many) ───
model TripBoat {
  id     String @id @default(uuid())
  tripId String
  boatId String
  role   String @default("primary") // primary | support | tender | rescue
  notes  String?

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  boat Boat @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@unique([tripId, boatId])
  @@index([tripId])
  @@index([boatId])
}

// ─── Kit custom field values ───
model KitFieldValue {
  id    String @id @default(uuid())
  kitId String
  key   String
  value String @default("")

  kit   Kit    @relation(fields: [kitId], references: [id], onDelete: Cascade)

  @@unique([kitId, key])
}

// ─── Kit component status (per-slot) ───
model KitComponentStatus {
  id          String @id @default(uuid())
  kitId       String
  componentId String
  slotIndex   Int    @default(0) // for qty > 1
  status      String @default("GOOD") // GOOD | MISSING | DAMAGED

  kit       Kit       @relation(fields: [kitId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([kitId, componentId, slotIndex])
}

// ─── Kit serial numbers per component slot ───
model KitSerial {
  id          String @id @default(uuid())
  kitId       String
  componentId String
  slotIndex   Int    @default(0)
  serial      String @default("")

  kit       Kit       @relation(fields: [kitId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([kitId, componentId, slotIndex])
}

// ─── Kit calibration dates per component slot ───
model KitCalibrationDate {
  id          String    @id @default(uuid())
  kitId       String
  componentId String
  slotIndex   Int       @default(0)
  calibDate   DateTime?

  kit       Kit       @relation(fields: [kitId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([kitId, componentId, slotIndex])
}

// ─── Inspections ───
model Inspection {
  id        String   @id @default(uuid())
  kitId     String
  inspector String?
  date      DateTime @default(now())
  notes     String?
  createdAt DateTime @default(now())

  kit     Kit                @relation(fields: [kitId], references: [id], onDelete: Cascade)
  results InspectionResult[]
  photos  InspectionPhoto[]

  @@index([kitId])
  @@index([date])
}

model InspectionResult {
  id           String @id @default(uuid())
  inspectionId String
  componentId  String
  slotIndex    Int    @default(0)
  status       String // GOOD | MISSING | DAMAGED
  serial       String?

  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  component  Component  @relation(fields: [componentId], references: [id], onDelete: Cascade)
}

model InspectionPhoto {
  id           String @id @default(uuid())
  inspectionId String
  filename     String
  originalName String
  date         DateTime @default(now())

  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
}

// ─── Kit Photos ───
model KitPhoto {
  id       String   @id @default(uuid())
  kitId    String
  filename String
  originalName String
  date     DateTime @default(now())

  kit Kit @relation(fields: [kitId], references: [id], onDelete: Cascade)
}

// ─── Issue History (checkout/return) ───
model IssueHistory {
  id              String    @id @default(uuid())
  kitId           String
  personId        String?
  issuedById      String?
  issuedDate      DateTime  @default(now())
  returnedDate    DateTime?
  returnNotes     String?
  checkoutLocId   String?
  returnLocId     String?
  checkoutSerials Json?     // { compKey: serial }
  returnSerials   Json?     // { compKey: serial }
  createdAt       DateTime  @default(now())

  kit      Kit  @relation(fields: [kitId], references: [id], onDelete: Cascade)
  person   User? @relation("IssuedTo", fields: [personId], references: [id], onDelete: SetNull)
  issuedBy User? @relation("IssuedBy", fields: [issuedById], references: [id], onDelete: SetNull)

  @@index([kitId])
  @@index([personId])
}

// ─── Checkout Requests (pending approval) ───
model CheckoutRequest {
  id           String    @id @default(uuid())
  kitId        String
  personId     String?
  deptId       String?
  status       String    @default("pending") // pending | approved | denied
  serials      Json?
  notes        String?
  resolvedById String?
  resolvedDate DateTime?
  createdAt    DateTime  @default(now())

  kit        Kit         @relation(fields: [kitId], references: [id], onDelete: Cascade)
  person     User?       @relation("Requester", fields: [personId], references: [id], onDelete: SetNull)
  department Department? @relation(fields: [deptId], references: [id], onDelete: SetNull)
  resolvedBy User?       @relation("Resolver", fields: [resolvedById], references: [id], onDelete: SetNull)

  @@index([status])
}

// ─── Reservations ───
model Reservation {
  id          String   @id @default(uuid())
  kitId       String
  personId    String?
  tripId      String?
  startDate   DateTime
  endDate     DateTime
  purpose     String?
  status      String   @default("pending") // pending | confirmed | cancelled
  createdAt   DateTime @default(now())

  kit    Kit   @relation(fields: [kitId], references: [id], onDelete: Cascade)
  person User?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  trip   Trip?  @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([kitId])
  @@index([tripId])
  @@index([startDate, endDate])
}

// ─── Maintenance History ───
model MaintenanceHistory {
  id            String    @id @default(uuid())
  kitId         String
  type          String    // repair | calibration | upgrade | cleaning
  reason        String?
  notes         String?
  startDate     DateTime  @default(now())
  endDate       DateTime?
  startedById   String?
  completedById String?
  createdAt     DateTime  @default(now())

  kit         Kit   @relation(fields: [kitId], references: [id], onDelete: Cascade)
  startedBy   User? @relation("MaintStartedBy", fields: [startedById], references: [id], onDelete: SetNull)
  completedBy User? @relation("MaintCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)

  @@index([kitId])
}

// ─── Consumables ───
model Consumable {
  id        String   @id @default(uuid())
  name      String
  sku       String?
  category  String   @default("Other")
  qty       Int      @default(0)
  minQty    Int      @default(0)
  unit      String   @default("ea")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Standalone Assets ───
model StandaloneAsset {
  id            String    @id @default(uuid())
  name          String
  serial        String
  category      String    @default("Other")
  locId         String?
  issuedToId    String?
  lastInspected DateTime?
  condition     String    @default("GOOD") // GOOD | DAMAGED | MISSING
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  location      Location?          @relation(fields: [locId], references: [id], onDelete: SetNull)
  issueHistory  AssetIssueHistory[]

  @@index([category])
}

model AssetIssueHistory {
  id           String    @id @default(uuid())
  assetId      String
  personId     String?
  issuedById   String?
  issuedDate   DateTime  @default(now())
  returnedDate DateTime?

  asset    StandaloneAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  person   User?           @relation("AssetIssuedTo", fields: [personId], references: [id], onDelete: SetNull)
  issuedBy User?           @relation("AssetIssuedBy", fields: [issuedById], references: [id], onDelete: SetNull)

  @@index([assetId])
}

// ─── Audit Log ───
model AuditLog {
  id       String   @id @default(uuid())
  action   String
  target   String   // kit | asset | consumable | user | etc
  targetId String?
  userId   String?
  date     DateTime @default(now())
  details  Json?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([action])
  @@index([date])
  @@index([targetId])
}

// ─── Trip Tasks / Checklists ───
model TripTask {
  id            String    @id @default(uuid())
  tripId        String
  title         String
  description   String?
  assignedToId  String?
  phase         String    @default("pre-deployment") // pre-deployment | deployment | post-deployment
  priority      String    @default("medium")         // low | medium | high | critical
  status        String    @default("todo")           // todo | in-progress | blocked | done
  dueDate       DateTime?
  completedAt   DateTime?
  completedById String?
  sortOrder     Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  trip        Trip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  assignedTo  User? @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  completedBy User? @relation("TaskCompleter", fields: [completedById], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@index([tripId, phase])
  @@index([assignedToId])
}

model TaskTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  tasks       Json     // array of { title, description?, phase, priority, sortOrder }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ─── Packing Templates (personal packing list templates per trip role) ───
model PackingTemplate {
  id        String   @id @default(uuid())
  name      String
  role      String?
  category  String   @default("general")
  items     Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Trip Packing Items (trip-specific packing list items) ───
model TripPackingItem {
  id        String   @id @default(uuid())
  tripId    String
  tier      String
  scope     String
  category  String   @default("general")
  name      String
  quantity  Int      @default(1)
  notes     String?
  required  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([tripId, tier])
}

// ─── Trip Packing Checks (per-person checklist state) ───
model TripPackingCheck {
  id        String    @id @default(uuid())
  tripId    String
  userId    String
  itemKey   String
  checked   Boolean   @default(false)
  checkedAt DateTime?

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation("PackingChecks", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId, itemKey])
  @@index([tripId, userId])
}

// ─── Trip Communications Plan ───
model TripCommsEntry {
  id           String   @id @default(uuid())
  tripId       String
  type         String   @default("radio_channel")  // radio_channel | phone | email | satellite | other
  label        String                               // e.g. "Primary Ops", "Emergency", "Base Camp", "Coast Guard"
  value        String                               // e.g. "Ch 16", "+1-555-0100", "156.8 MHz"
  assignedToId String?                              // who monitors this channel/contact
  notes        String?
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  trip       Trip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  assignedTo User? @relation("CommsAssignment", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([tripId])
}

// ─── System Settings ───
model SystemSetting {
  key   String @id
  value Json
}
